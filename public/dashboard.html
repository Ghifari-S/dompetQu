<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction Dashboard</title>
</head>
<body>
  <h1>Transaction Dashboard</h1>
  
  <form id="transaction-form">
    <input type="text" id="title" placeholder="Transaction title" required>
    <input type="number" id="amount" placeholder="Amount" required step="0.01">
    <button type="submit">Add Transaction</button>
  </form>
  <div id="error-message" class="error-message"></div>

  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="transaction-table"></tbody>
  </table>

  <button onclick="logout()" class="logout-btn">Logout</button>

  <script>
    // Authentication and Initialization
    let currentUserId = null;
    
    async function initializeApp() {
      try {
        await checkAuth();
        await fetchTransactions();
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize application');
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) {
          throw new Error('Not authenticated');
        }
        const data = await res.json();
        currentUserId = data.user.userId;
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = '/login.html';
      }
    }

    // Transaction Functions
    async function fetchTransactions() {
      try {
        const res = await fetch('/api/transactions');
        if (!res.ok) {
          throw new Error('Failed to fetch transactions');
        }
        const transactions = await res.json();
        renderTransactions(transactions);
      } catch (error) {
        console.error('Fetch transactions error:', error);
        showError('Failed to load transactions');
      }
    }

    function renderTransactions(transactions) {
      const tbody = document.getElementById('transaction-table');
      tbody.innerHTML = '';
      
      if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No transactions found</td></tr>';
        return;
      }

      transactions.forEach(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(tx.title)}</td>
          <td>${formatCurrency(tx.amount)}</td>
          <td class="date-cell">${formatDate(tx.date || new Date().toISOString())}</td>
          <td><button onclick="deleteTx(${tx.id})" class="delete-btn">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addTransaction(title, amount) {
      try {
        // Automatically add current date
        const date = new Date().toISOString();
        
        const res = await fetch('/api/transactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, amount, date })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || 'Failed to add transaction');
        }

        await fetchTransactions();
        document.getElementById('transaction-form').reset();
      } catch (error) {
        console.error('Add transaction error:', error);
        showError(error.message || 'Failed to add transaction');
      }
    }

    async function deleteTx(id) {
      if (!confirm('Are you sure you want to delete this transaction?')) {
        return;
      }

      try {
        const res = await fetch(`/api/transactions?id=${id}`, { 
          method: 'DELETE' 
        });

        if (!res.ok) {
          throw new Error('Failed to delete transaction');
        }

        await fetchTransactions();
      } catch (error) {
        console.error('Delete transaction error:', error);
        showError('Failed to delete transaction');
      }
    }

    // Helper Functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      setTimeout(() => errorElement.textContent = '', 5000);
    }

    // Event Listeners
    document.getElementById('transaction-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      
      if (!title || isNaN(amount)) {
        showError('Please enter valid title and amount');
        return;
      }

      await addTransaction(title, amount);
    });

    async function logout() {
      try {
        const res = await fetch('/api/auth/logout');
        if (!res.ok) {
          throw new Error('Logout failed');
        }
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        showError('Failed to logout');
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>